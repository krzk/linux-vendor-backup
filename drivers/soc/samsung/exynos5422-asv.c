// SPDX-License-Identifier: GPL-2.0
/*
 * Copyright (c) 2018 Samsung Electronics Co., Ltd.
 *	      http://www.samsung.com/
 *
 * Samsung Exynos 5422 SoC Adaptive Supply Voltage support
 */

#include <linux/bitrev.h>
#include <linux/cpu.h>
#include <linux/device.h>
#include <linux/errno.h>
#include <linux/init.h>
#include <linux/io.h>
#include <linux/irqchip.h>
#include <linux/of.h>
#include <linux/of_address.h>
#include <linux/of_fdt.h>
#include <linux/platform_device.h>
#include <linux/pm_opp.h>

#include "exynos-asv.h"
#include "exynos-chipid.h"

#define EXYNOS5422_ASV_NUM		14

#define EXYNOS5422_ARM_DVFS_NUM		20
#define EXYNOS5422_ARM_BIN2_DVFS_NUM	17

#define EXYNOS5422_KFC_DVFS_NUM		14
#define EXYNOS5422_KFC_BIN2_DVFS_NUM	12

static struct exynos_asv *exynos_asv;

static const unsigned int arm_info_table01[EXYNOS5422_ARM_DVFS_NUM][EXYNOS_ASV_MAX_NUM + 1] = {
	{ 2100, 1362500, 1362500, 1350000, 1337500, 1325000, 1312500, 1300000, 1275000, 1262500, 1250000, 1237500, 1225000, 1212500, 1200000 },
	{ 2000, 1312500, 1312500, 1300000, 1287500, 1275000, 1262500, 1250000, 1237500, 1225000, 1237500, 1225000, 1212500, 1200000, 1187500 },
	{ 1900, 1250000, 1237500, 1225000, 1212500, 1200000, 1187500, 1175000, 1162500, 1150000, 1162500, 1150000, 1137500, 1125000, 1112500 },
	{ 1800, 1200000, 1187500, 1175000, 1162500, 1150000, 1137500, 1125000, 1112500, 1100000, 1112500, 1100000, 1087500, 1075000, 1062500 },
	{ 1700, 1162500, 1150000, 1137500, 1125000, 1112500, 1100000, 1087500, 1075000, 1062500, 1075000, 1062500, 1050000, 1037500, 1025000 },
	{ 1600, 1125000, 1112500, 1100000, 1087500, 1075000, 1062500, 1050000, 1037500, 1025000, 1037500, 1025000, 1012500, 1000000,  987500 },
	{ 1500, 1087500, 1075000, 1062500, 1050000, 1037500, 1025000, 1012500, 1000000,  987500, 1000000,  987500,  975000,  962500,  950000 },
	{ 1400, 1062500, 1050000, 1037500, 1025000, 1012500, 1000000,  987500,  975000,  962500,  975000,  962500,  950000,  937500,  925000 },
	{ 1300, 1050000, 1037500, 1025000, 1012500, 1000000,  987500,  975000,  962500,  950000,  962500,  950000,  937500,  925000,  912500 },
	{ 1200, 1025000, 1012500, 1000000,  987500,  975000,  962500,  950000,  937500,  925000,  937500,  925000,  912500,  900000,  900000 },
	{ 1100, 1000000,  987500,  975000,  962500,  950000,  937500,  925000,  912500,  900000,  900000,  900000,  900000,  900000,  900000 },
	{ 1000,  975000,  962500,  950000,  937500,  925000,  912500,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  900,  950000,  937500,  925000,  912500,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  800,  925000,  912500,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  700,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  600,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  500,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  400,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  300,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  200,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
};

static const unsigned int arm_info_table2[EXYNOS5422_ARM_DVFS_NUM][EXYNOS_ASV_MAX_NUM + 1] = {
	{ 2100, 1362500, 1362500, 1350000, 1337500, 1325000, 1312500, 1300000, 1275000, 1262500, 1250000, 1237500, 1225000, 1212500, 1200000 },
	{ 2000, 1312500, 1312500, 1312500, 1300000, 1275000, 1262500, 1250000, 1237500, 1225000, 1237500, 1225000, 1212500, 1200000, 1187500 },
	{ 1900, 1262500, 1250000, 1250000, 1237500, 1212500, 1200000, 1187500, 1175000, 1162500, 1175000, 1162500, 1150000, 1137500, 1125000 },
	{ 1800, 1212500, 1200000, 1187500, 1175000, 1162500, 1150000, 1137500, 1125000, 1112500, 1125000, 1112500, 1100000, 1087500, 1075000 },
	{ 1700, 1175000, 1162500, 1150000, 1137500, 1125000, 1112500, 1100000, 1087500, 1075000, 1087500, 1075000, 1062500, 1050000, 1037500 },
	{ 1600, 1137500, 1125000, 1112500, 1100000, 1087500, 1075000, 1062500, 1050000, 1037500, 1050000, 1037500, 1025000, 1012500, 1000000 },
	{ 1500, 1100000, 1087500, 1075000, 1062500, 1050000, 1037500, 1025000, 1012500, 1000000, 1012500, 1000000,  987500,  975000,  962500 },
	{ 1400, 1075000, 1062500, 1050000, 1037500, 1025000, 1012500, 1000000,  987500,  975000,  987500,  975000,  962500,  950000,  937500 },
	{ 1300, 1050000, 1037500, 1025000, 1012500, 1000000,  987500,  975000,  962500,  950000,  962500,  950000,  937500,  925000,  912500 },
	{ 1200, 1025000, 1012500, 1000000,  987500,  975000,  962500,  950000,  937500,  925000,  937500,  925000,  912500,  900000,  900000 },
	{ 1100, 1000000,  987500,  975000,  962500,  950000,  937500,  925000,  912500,  900000,  900000,  900000,  900000,  900000,  900000 },
	{ 1000,  975000,  962500,  950000,  937500,  925000,  912500,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  900,  950000,  937500,  925000,  912500,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  800,  925000,  912500,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  700,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  600,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  500,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  400,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  300,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  200,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
};

static const unsigned int arm_info_table3[EXYNOS5422_ARM_DVFS_NUM][EXYNOS_ASV_MAX_NUM + 1] = {
	{ 2100, 1362500, 1362500, 1350000, 1337500, 1325000, 1312500, 1300000, 1275000, 1262500, 1250000, 1237500, 1225000, 1212500, 1200000 },
	{ 2000, 1312500, 1312500, 1300000, 1287500, 1275000, 1262500, 1250000, 1237500, 1225000, 1237500, 1225000, 1212500, 1200000, 1187500 },
	{ 1900, 1262500, 1250000, 1237500, 1225000, 1212500, 1200000, 1187500, 1175000, 1162500, 1175000, 1162500, 1150000, 1137500, 1125000 },
	{ 1800, 1212500, 1200000, 1187500, 1175000, 1162500, 1150000, 1137500, 1125000, 1112500, 1125000, 1112500, 1100000, 1087500, 1075000 },
	{ 1700, 1175000, 1162500, 1150000, 1137500, 1125000, 1112500, 1100000, 1087500, 1075000, 1087500, 1075000, 1062500, 1050000, 1037500 },
	{ 1600, 1137500, 1125000, 1112500, 1100000, 1087500, 1075000, 1062500, 1050000, 1037500, 1050000, 1037500, 1025000, 1012500, 1000000 },
	{ 1500, 1100000, 1087500, 1075000, 1062500, 1050000, 1037500, 1025000, 1012500, 1000000, 1012500, 1000000,  987500,  975000,  962500 },
	{ 1400, 1075000, 1062500, 1050000, 1037500, 1025000, 1012500, 1000000,  987500,  975000,  987500,  975000,  962500,  950000,  937500 },
	{ 1300, 1050000, 1037500, 1025000, 1012500, 1000000,  987500,  975000,  962500,  950000,  962500,  950000,  937500,  925000,  912500 },
	{ 1200, 1025000, 1012500, 1000000,  987500,  975000,  962500,  950000,  937500,  925000,  937500,  925000,  912500,  900000,  900000 },
	{ 1100, 1000000,  987500,  975000,  962500,  950000,  937500,  925000,  912500,  900000,  900000,  900000,  900000,  900000,  900000 },
	{ 1000,  975000,  962500,  950000,  937500,  925000,  912500,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  900,  950000,  937500,  925000,  912500,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  800,  925000,  912500,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  700,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  600,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  500,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  400,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  300,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  200,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
};

static const unsigned int arm_info_bin2[EXYNOS5422_ARM_BIN2_DVFS_NUM][EXYNOS_ASV_MAX_NUM + 1] = {
	{ 1800, 1237500, 1225000, 1212500, 1200000, 1187500, 1175000, 1162500, 1150000, 1137500, 1150000, 1137500, 1125000, 1112500, 1100000 },
	{ 1700, 1200000, 1187500, 1175000, 1162500, 1150000, 1137500, 1125000, 1112500, 1100000, 1112500, 1100000, 1087500, 1075000, 1062500 },
	{ 1600, 1162500, 1150000, 1137500, 1125000, 1112500, 1100000, 1087500, 1075000, 1062500, 1075000, 1062500, 1050000, 1037500, 1025000 },
	{ 1500, 1125000, 1112500, 1100000, 1087500, 1075000, 1062500, 1050000, 1037500, 1025000, 1037500, 1025000, 1012500, 1000000, 987500 },
	{ 1400, 1100000, 1087500, 1075000, 1062500, 1050000, 1037500, 1025000, 1012500, 1000000, 1012500, 1000000, 987500,  975000,  962500 },
	{ 1300, 1087500, 1075000, 1062500, 1050000, 1037500, 1025000, 1012500, 1000000, 987500,  1000000, 987500,  975000,  962500,  950000 },
	{ 1200, 1062500, 1050000, 1037500, 1025000, 1012500, 1000000, 987500,  975000,  962500,  975000,  962500,  950000,  937500,  925000 },
	{ 1100, 1037500, 1025000, 1012500, 1000000, 987500,  975000,  962500,  950000,  937500,  950000,  937500,  925000,  912500,  900000 },
	{ 1000, 1012500, 1000000,  987500,  975000, 962500,  950000,  937500,  925000,  912500,  925000,  912500,  900000,  900000,  900000 },
	{  900,  987500,  975000,  962500,  950000, 937500,  925000,  912500,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  800,  962500,  950000,  937500,  925000, 912500,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  700,  937500,  925000,  912500,  900000, 900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  600,  900000,  900000,  900000,  900000, 900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  500,  900000,  900000,  900000,  900000, 900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  400,  900000,  900000,  900000,  900000, 900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  300,  900000,  900000,  900000,  900000, 900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  200,  900000,  900000,  900000,  900000, 900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
};

static const unsigned int kfc_info_table01[EXYNOS5422_KFC_DVFS_NUM][EXYNOS_ASV_MAX_NUM + 1] = {
	{ 1500, 1300000, 1300000, 1300000, 1287500, 1287500, 1287500, 1275000, 1262500, 1250000, 1237500, 1225000, 1212500, 1200000, 1187500 },
	{ 1400, 1275000, 1262500, 1250000, 1237500, 1225000, 1212500, 1200000, 1187500, 1175000, 1162500, 1150000, 1137500, 1125000, 1112500 },
	{ 1300, 1225000, 1212500, 1200000, 1187500, 1175000, 1162500, 1150000, 1137500, 1125000, 1112500, 1100000, 1087500, 1075000, 1062500 },
	{ 1200, 1175000, 1162500, 1150000, 1137500, 1125000, 1112500, 1100000, 1087500, 1075000, 1062500, 1050000, 1037500, 1025000, 1012500 },
	{ 1100, 1137500, 1125000, 1112500, 1100000, 1087500, 1075000, 1062500, 1050000, 1037500, 1025000, 1012500, 1000000,  987500,  975000 },
	{ 1000, 1100000, 1087500, 1075000, 1062500, 1050000, 1037500, 1025000, 1012500, 1000000,  987500,  975000,  962500,  950000,  937500 },
	{  900, 1062500, 1050000, 1037500, 1025000, 1012500, 1000000,  987500,  975000,  962500,  950000,  937500,  925000,  912500,  900000 },
	{  800, 1025000, 1012500, 1000000,  987500,  975000,  962500,  950000,  937500,  925000,  912500,  900000,  900000,  900000,  900000 },
	{  700,  987500,  975000,  962500,  950000,  937500,  925000,  912500,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  600,  950000,  937500,  925000,  912500,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  500,  912500,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  400,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  300,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  200,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
};

static const unsigned int kfc_info_table2[EXYNOS5422_KFC_DVFS_NUM][EXYNOS_ASV_MAX_NUM + 1] = {
	{ 1500, 1300000, 1300000, 1300000, 1287500, 1287500, 1287500, 1275000, 1262500, 1250000, 1237500, 1225000, 1212500, 1200000, 1187500 },
	{ 1400, 1275000, 1262500, 1250000, 1237500, 1225000, 1212500, 1200000, 1187500, 1175000, 1162500, 1150000, 1137500, 1125000, 1112500 },
	{ 1300, 1225000, 1212500, 1200000, 1187500, 1175000, 1162500, 1150000, 1137500, 1125000, 1112500, 1100000, 1087500, 1075000, 1062500 },
	{ 1200, 1175000, 1162500, 1150000, 1137500, 1125000, 1112500, 1100000, 1087500, 1075000, 1062500, 1050000, 1037500, 1025000, 1012500 },
	{ 1100, 1137500, 1125000, 1112500, 1100000, 1087500, 1075000, 1062500, 1050000, 1037500, 1025000, 1012500, 1000000,  987500,  975000 },
	{ 1000, 1100000, 1087500, 1075000, 1062500, 1050000, 1037500, 1025000, 1012500, 1000000,  987500,  975000,  962500,  950000,  937500 },
	{  900, 1062500, 1050000, 1037500, 1025000, 1012500, 1000000,  987500,  975000,  962500,  950000,  937500,  925000,  912500,  900000 },
	{  800, 1025000, 1012500, 1000000,  987500,  975000,  962500,  950000,  937500,  925000,  912500,  900000,  900000,  900000,  900000 },
	{  700,  987500,  975000,  962500,  950000,  937500,  925000,  912500,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  600,  950000,  937500,  925000,  912500,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  500,  912500,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  400,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  300,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  200,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
};

static const unsigned int kfc_info_table3[EXYNOS5422_KFC_DVFS_NUM][EXYNOS_ASV_MAX_NUM + 1] = {
	{ 1500, 1300000, 1300000, 1300000, 1287500, 1287500, 1287500, 1275000, 1262500, 1250000, 1237500, 1225000, 1212500, 1200000, 1187500 },
	{ 1400, 1275000, 1262500, 1250000, 1237500, 1225000, 1212500, 1200000, 1187500, 1175000, 1162500, 1150000, 1137500, 1125000, 1112500 },
	{ 1300, 1225000, 1212500, 1200000, 1187500, 1175000, 1162500, 1150000, 1137500, 1125000, 1112500, 1100000, 1087500, 1075000, 1062500 },
	{ 1200, 1175000, 1162500, 1150000, 1137500, 1125000, 1112500, 1100000, 1087500, 1075000, 1062500, 1050000, 1037500, 1025000, 1012500 },
	{ 1100, 1137500, 1125000, 1112500, 1100000, 1087500, 1075000, 1062500, 1050000, 1037500, 1025000, 1012500, 1000000,  987500,  975000 },
	{ 1000, 1100000, 1087500, 1075000, 1062500, 1050000, 1037500, 1025000, 1012500, 1000000,  987500,  975000,  962500,  950000,  937500 },
	{  900, 1062500, 1050000, 1037500, 1025000, 1012500, 1000000,  987500,  975000,  962500,  950000,  937500,  925000,  912500,  900000 },
	{  800, 1025000, 1012500, 1000000,  987500,  975000,  962500,  950000,  937500,  925000,  912500,  900000,  900000,  900000,  900000 },
	{  700,  987500,  975000,  962500,  950000,  937500,  925000,  912500,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  600,  950000,  937500,  925000,  912500,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  500,  912500,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  400,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  300,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  200,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
};

static const unsigned int kfc_info_bin2[EXYNOS5422_KFC_BIN2_DVFS_NUM][EXYNOS_ASV_MAX_NUM + 1] = {
	{ 1300, 1250000, 1237500, 1225000, 1212500, 1200000, 1187500, 1175000, 1162500, 1150000, 1137500, 1125000, 1112500, 1100000, 1087500 },
	{ 1200, 1200000, 1187500, 1175000, 1162500, 1150000, 1137500, 1125000, 1112500, 1100000, 1087500, 1075000, 1062500, 1050000, 1037500 },
	{ 1100, 1162500, 1150000, 1137500, 1125000, 1112500, 1100000, 1087500, 1075000, 1062500, 1050000, 1037500, 1025000, 1012500, 1000000 },
	{ 1000, 1125000, 1112500, 1100000, 1087500, 1075000, 1062500, 1050000, 1037500, 1025000, 1012500, 1000000,  987500,  975000,  962500 },
	{  900, 1087500, 1075000, 1062500, 1050000, 1037500, 1025000, 1012500, 1000000,  987500,  975000,  962500,  950000,  937500,  925000 },
	{  800, 1050000, 1037500, 1025000, 1012500, 1000000,  987500,  975000,  962500,  950000,  937500,  925000,  912500,  900000,  900000 },
	{  700, 1012500, 1000000,  987500,  975000,  962500,  950000,  937500,  925000,  912500,  900000,  900000,  900000,  900000,  900000 },
	{  600,  975000,  962500,  950000,  937500,  925000,  912500,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  500,  937500,  925000,  912500,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  400,  925000,  912500,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  300,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },
	{  200,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000,  900000 },

};

static int exynos5422_asv_opp_get_voltage(struct exynos_asv_subsys *subsys,
				int idx, unsigned int freq, unsigned int volt)
{
	unsigned int i, asv_volt;

	for (i = 0; i < subsys->dvfs_nr; i++) {
		if (freq == subsys->asv_table[i][0])
			break;
	}

	if (i == subsys->dvfs_nr)
		return	0;

	asv_volt = subsys->asv_table[i][exynos_asv->group + 1];

	if (volt > subsys->base_volt)
		asv_volt += subsys->offset_volt_h;
	else
		asv_volt += subsys->offset_volt_l;

	return asv_volt;
}

static int exynos5422_asv_get_bin2(void)
{
	unsigned int reg = exynos_chipid_read(EXYNOS_CHIPID_REG_PKG_ID);

	return (reg >> EXYNOS5422_BIN2_OFFSET) & EXYNOS5422_BIN2_MASK;
}

static bool exynos5422_asv_special_group_check(void)
{
	unsigned int reg = exynos_chipid_read(EXYNOS_CHIPID_REG_PKG_ID);

	return (((reg >> EXYNOS5422_USESG_OFFSET) & EXYNOS5422_USESG_MASK)
		&& exynos_asv->bin2 == 0);
}

static const struct asv_limit_entry exynos5422_asv_limits[EXYNOS5422_ASV_NUM] = {
	{ 13, 55 },
	{ 21, 65 },
	{ 25, 69 },
	{ 30, 72 },
	{ 36, 74 },
	{ 43, 76 },
	{ 51, 78 },
	{ 65, 80 },
	{ 81, 82 },
	{ 98, 84 },
	{ 119, 87 },
	{ 135, 89 },
	{ 150, 92 },
	{ 999, 999 },
};

static int exynos5422_asv_get_group(struct exynos_asv *exynos_asv)
{
	unsigned int pkgid_reg = exynos_chipid_read(EXYNOS_CHIPID_REG_PKG_ID);
	unsigned int auxi_reg = exynos_chipid_read(EXYNOS_CHIPID_AUX_INFO);
	int hpm, ids, i;

	if (exynos_asv->special_lot) {
		u32 sga = (pkgid_reg >> EXYNOS5422_SG_A_OFFSET) &
			   EXYNOS5422_SG_A_MASK;

		u32 sgb = (pkgid_reg >> EXYNOS5422_SG_B_OFFSET) &
			   EXYNOS5422_SG_B_MASK;

		if ((pkgid_reg >> EXYNOS5422_SG_BSIGN_OFFSET) &
		     EXYNOS5422_SG_BSIGN_MASK)
			return sga + sgb;
		else
			return sga - sgb;
	}

	hpm = (auxi_reg >> EXYNOS5422_TMCB_OFFSET) & EXYNOS5422_TMCB_MASK;
	ids = (pkgid_reg >> EXYNOS5422_IDS_OFFSET) & EXYNOS5422_IDS_MASK;

	for (i = 0; i < EXYNOS5422_ASV_NUM; i++) {
		if (ids <= exynos5422_asv_limits[i].ids)
			break;
		if (hpm <= exynos5422_asv_limits[i].hpm)
			break;
	}

	if (i < EXYNOS5422_ASV_NUM)
		return i;
	else
		return 0;
}

static int exynos5422_asv_get_table(void)
{
	unsigned int pkg_id_reg = exynos_chipid_read(EXYNOS_CHIPID_REG_PKG_ID);

	return	(pkg_id_reg >> EXYNOS5422_TABLE_OFFSET) & EXYNOS5422_TABLE_MASK;
}

static int __asv_offset_voltage(unsigned int index)
{
	static const unsigned int offset_table[] = { 12500, 50000, 25000 };

	if (index == 0 || index > 3)
		return 0;

	return offset_table[index - 1];
}

static void exynos5422_asv_offset_voltage_setup(void)
{
	struct exynos_asv_subsys *subsys;
	unsigned int reg, value;

	if (exynos_asv->bin2) {
		exynos_asv->arm.dvfs_nr = EXYNOS5422_ARM_BIN2_DVFS_NUM;
		exynos_asv->kfc.dvfs_nr = EXYNOS5422_KFC_BIN2_DVFS_NUM;
	} else {
		exynos_asv->arm.dvfs_nr = EXYNOS5422_ARM_DVFS_NUM;
		exynos_asv->kfc.dvfs_nr = EXYNOS5422_KFC_DVFS_NUM;
	}

	reg = exynos_chipid_read(EXYNOS_CHIPID_AUX_INFO);

	/* ARM offset voltage setup */
	subsys = &exynos_asv->arm;

	subsys->base_volt = 1000000;

	value = (reg >> EXYNOS5422_ARM_UP_OFFSET) & EXYNOS5422_ARM_UP_MASK;
	subsys->offset_volt_h = __asv_offset_voltage(value);

	value = (reg >> EXYNOS5422_ARM_DN_OFFSET) & EXYNOS5422_ARM_DN_MASK;
	subsys->offset_volt_l = __asv_offset_voltage(value);

	/* KFC offset voltage setup */
	subsys = &exynos_asv->kfc;

	subsys->base_volt = 1000000;

	value = (reg >> EXYNOS5422_KFC_UP_OFFSET) & EXYNOS5422_KFC_UP_MASK;
	subsys->offset_volt_h = __asv_offset_voltage(value);

	value = (reg >> EXYNOS5422_KFC_DN_OFFSET) & EXYNOS5422_KFC_DN_MASK;
	subsys->offset_volt_l = __asv_offset_voltage(value);
}

int __init exynos5422_asv_init(struct exynos_asv *asv)
{
	exynos_asv = asv;

	asv->bin2 = exynos5422_asv_get_bin2();

	if (of_machine_is_compatible("hardkernel,odroid-xu3-lite"))
		asv->bin2 = true;

	asv->special_lot = exynos5422_asv_special_group_check();
	asv->group = exynos5422_asv_get_group(asv);
	asv->table = exynos5422_asv_get_table();

	exynos5422_asv_offset_voltage_setup();

	if (asv->bin2) {
		asv->arm.asv_table = arm_info_bin2;
		asv->kfc.asv_table = kfc_info_bin2;
	} else {
		switch(asv->table) {
		case 2:
			asv->arm.asv_table = arm_info_table2;
			asv->kfc.asv_table = kfc_info_table2;
			break;
		case 3:
			asv->arm.asv_table = arm_info_table3;
			asv->kfc.asv_table = kfc_info_table3;
			break;
		default:
			asv->arm.asv_table = arm_info_table01;
			asv->kfc.asv_table = kfc_info_table01;
			break;
		}
	}

	asv->arm.cpu_dt_compat = "arm,cortex-a15";
	asv->kfc.cpu_dt_compat = "arm,cortex-a7";

	asv->opp_get_voltage = exynos5422_asv_opp_get_voltage;


	return 0;
}
